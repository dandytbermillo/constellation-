Add Final Depth Logging and Reproduce Inline Promotion Bug
Inline Spotlight Depth Regression Analysis
Instrumentation and Logging
After adding a debugLog('depth:final') in getItemDepthLayer, we captured the depth assigned to each node when reproducing the issue. The key nodes and their final depths were:
Knowledge Base root – Remains in the background with a higher depth layer (e.g. depth 3). This is the main Knowledge Base center node, which stayed “inline” even after promotion.
personal info (spotlight center) – The promoted folder becomes the new spotlight center. It was expected to be at the front (depth 0), but due to how the root layer was calculated, it was initially assigned depth 1 in the override map. (In effect, the spotlight center wasn’t placed at 0 as one might expect.) The final computed depth for personal info was logged as depth 2 after the global offset was applied.
testing (inline-expanded child) – This node retained an inline context depth instead of moving fully forward with the spotlight. The logs show that an “inline” traversal pass assigned testing’s depth before the spotlight pass ran. As a result, testing ended up at depth 2 in the final state (stuck at the same layer as its parent, rather than one layer forward).
Children of testing – The grandchildren of personal info remained at the inline expansion depth (e.g. depth 3). In other words, they stayed pushed back in the visualization. The debug logs confirm these descendants “don’t move forward” when personal info is spotlighted.
Cause: Inline Context Overriding Spotlight Depth
The debug output and traversal logs indicate that the inline expansion state was still influencing depth calculations even after promoting personal info to a spotlight. In the logs, the Knowledge Base branch continued to run in an inline mode on recompute (with branchHasInline: true) and re-processed testing as if it were still an inline-expanded branch. Specifically:
The Knowledge Base root remained marked as inline-expanded (it was not removed from the inline set during promotion). This caused branchDepthOverrides to execute a “knowledge-base inline” pass even after personal info became the focused constellation.
During that pass, testing was visited with contextMode: 'inline'. The inline traversal assigned a depth layer to testing and its children before the spotlight’s own pass could adjust them. In effect, the inline context depth “locked” those nodes at a back layer.
When the spotlight (focused) branch was processed (branchMode: 'spotlight-active' for personal info), it computed depths for testing and its children as well. However, because branchDepthOverrides keeps the lowest (most forward) depth for each node, the prior inline assignment prevented any update. The inline pass had already given testing a relatively shallow layer (and left its children deeper), so the spotlight calculation couldn’t bring them forward. This is why testing and its descendants retained their inline depth values instead of adopting new spotlight-relative depths.
Notably, the instrumentation did not show any logic in getItemDepthLayer itself forcing this behavior. The incorrect depths were determined before getItemDepthLayer returned, via the cascade of depth overrides. In other words, the bug originates in the branch traversal and override assignment (the inline cascade) rather than in the final getItemDepthLayer calculations. The getItemDepthLayer function simply returned the depths from the override map, which in this case reflected the stale inline context.
Solution Recommendation
To fix this regression, we need to prevent the inline context from overshadowing the spotlight depth for promoted branches. Two possible approaches (drawn from the debug analysis) are:
Clear Inline Flags for Ancestors: When promoting a branch to spotlight, also remove its ancestors (e.g. the Knowledge Base root and any parent folders) from state.inlineExpandedConstellations. In our case, the logs show that promotion removed personal info and testing from the inline set, but the Knowledge Base root remained. Removing the Knowledge Base from the inline-expanded set during the promotion would stop the extra “inline” traversal pass for that branch. This ensures that once personal info is spotlighted, branchDepthOverrides won’t treat the Knowledge Base branch as inline, and thus won’t reassign depths to testing in an inline context.
Skip Inline Traversal in Code: Alternatively, modify the branchDepthOverrides logic to detect when a promoted branch’s ancestor is the Knowledge Base and skip the inline re-traversal for that ancestor while the spotlight is active. For example, the code could check if the active spotlight’s parent (or root) is the Knowledge Base and temporarily disable processing the Knowledge Base branch in inline mode. This would prevent the “knowledge-base inline” depth assignment from running when it’s not desired.
Implementing either change would allow the spotlight calculation to fully determine the depths. The expectation is that testing and its children would then inherit the forward depths of the spotlighted branch, resolving the issue. After applying a patch, we should re-run the scenario and confirm via logs that the Knowledge Base branch no longer runs in inline mode during the spotlight, and that testing’s descendants move to the intended front layers. In summary, the final depth assignments were indeed coming from the stale inline context rather than the new spotlight context. The fix is to ensure that once a branch is promoted, its former parent branch (Knowledge Base) no longer applies inline depth overrides to those nodes. Adjusting the promotion state or the depth override logic as described should correct the depth assignment so that spotlighted nodes and their descendants come forward as expected. Sources:
Debug log analysis of spotlight vs inline expansion depth calculations
Instrumented depth outputs confirming testing and its children remained at inline-assigned depths (grandchildren “don’t move forward”)
Proposed fixes based on observed log events and state transitions during promotion